- name: Read token from file
  slurp:
    src: "../grafana-token.txt"
  register: grafana_token_file

- name: Download Json for Dashboard in Grafana
  uri:
    url: "https://grafana.com/api/dashboards/16508/revisions/1/download"
    return_content: yes
  register: dashboard_json

- name: Replace data source references in the dashboard JSON
  set_fact:
    modified_json: "{{ dashboard_json.content | regex_replace('\\${DS_PROMETHEUS}', minecraft_prometheus_datasource) }}"
    
- name: Import the modified dashboard to Grafana
  community.grafana.grafana_dashboard:
    grafana_url: "https://www.verturus.com"
    grafana_api_key: "{{ grafana_token_file.content | b64decode | trim }}"
    dashboard_json: "{{ modified_json }}"